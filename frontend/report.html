

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaf Disease Detection and Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        #camera-feed {
            width: 100%;
            max-width: 640px;
            height: auto;
        }
        #capture-btn, #diagnose-btn {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        #diagnose-btn {
            background-color: #2ecc71;
        }
        #captured-image {
            display: none;
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .report-date {
            font-style: italic;
            color: #7f8c8d;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .chart-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .chart {
            width: 48%;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .chart {
                width: 100%;
            }
        }
        .severity-low { color: #2ecc71; }
        .severity-medium { color: #f39c12; }
        .severity-high { color: #e74c3c; }
        .progress-improving { color: #2ecc71; }
        .progress-stable { color: #3498db; }
        .progress-worsening { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>Leaf Disease Detection and Report</h1>

    <div class="camera-container">
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="capture-canvas" style="display:none;"></canvas>
        <img id="captured-image" alt="Captured leaf image">
        <button id="capture-btn">Capture Image</button>
        <button id="diagnose-btn" style="display:none;">Diagnose</button>
    </div>

    <div class="report-header">
        <h2>Leaf Disease Report</h2>
        <p class="report-date">Generated on: <span id="report-date"></span></p>
    </div>

    <table id="leaf-records">
        <thead>
            <tr>
                <th>Date</th>
                <th>Disease ID</th>
                <th>Leaf Name</th>
                <th>Disease Name</th>
                <th>Severity</th>
                <th>Progress</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table rows will be dynamically populated -->
        </tbody>
    </table>

    <h2>Disease Analysis</h2>
    <div class="chart-container">
        <div class="chart">
            <canvas id="disease-distribution"></canvas>
        </div>
        <div class="chart">
            <canvas id="severity-trend"></canvas>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('camera-feed');
        const captureButton = document.getElementById('capture-btn');
        const diagnoseButton = document.getElementById('diagnose-btn');
        const captureCanvas = document.getElementById('capture-canvas');
        const capturedImage = document.getElementById('captured-image');

        // Access the camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElement.srcObject = stream;
            } catch (err) {
                console.error('Error accessing the camera:', err);
            }
        }

        startCamera();

        // Capture image
        captureButton.addEventListener('click', () => {
            captureCanvas.width = videoElement.videoWidth;
            captureCanvas.height = videoElement.videoHeight;
            captureCanvas.getContext('2d').drawImage(videoElement, 0, 0);
            capturedImage.src = captureCanvas.toDataURL('image/jpeg');
            capturedImage.style.display = 'block';
            diagnoseButton.style.display = 'inline-block';
        });

        // Roboflow API integration
        const ROBOFLOW_API_KEY = 'YOUR_ROBOFLOW_API_KEY';
        const ROBOFLOW_MODEL = 'YOUR_MODEL_NAME/VERSION';

        diagnoseButton.addEventListener('click', async () => {
            const imageData = captureCanvas.toDataURL('image/jpeg').split(',')[1];

            try {
                const response = await fetch(`https://detect.roboflow.com/${ROBOFLOW_MODEL}?api_key=${ROBOFLOW_API_KEY}`, {
                    method: 'POST',
                    body: imageData,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                const result = await response.json();
                console.log('Roboflow API response:', result);

                // Process the result and update the report
                if (result.predictions && result.predictions.length > 0) {
                    const prediction = result.predictions[0];
                    const newRecord = {
                        date: new Date().toISOString().split('T')[0],
                        diseaseId: `D${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`,
                        leafName: 'Unknown', // You may need to implement leaf classification
                        diseaseName: prediction.class,
                        severity: getSeverity(prediction.confidence),
                        progress: 'New',
                        location: 'Camera'
                    };

                    addLeafRecord(newRecord);
                    updateCharts();
                } else {
                    console.log('No disease detected');
                }
            } catch (error) {
                console.error('Error calling Roboflow API:', error);
            }
        });

        function getSeverity(confidence) {
            if (confidence > 0.8) return 'High';
            if (confidence > 0.5) return 'Medium';
            return 'Low';
        }

        // Sample data and report generation (you can remove this when you have real data)
        let leafRecords = [
            { date: '2023-06-01', diseaseId: 'D001', leafName: 'Oak', diseaseName: 'Leaf Spot', severity: 'Low', progress: 'Improving', location: 'North Garden' },
            { date: '2023-06-03', diseaseId: 'D002', leafName: 'Maple', diseaseName: 'Powdery Mildew', severity: 'Medium', progress: 'Stable', location: 'East Orchard' },
            { date: '2023-06-05', diseaseId: 'D003', leafName: 'Pine', diseaseName: 'Needle Blight', severity: 'High', progress: 'Worsening', location: 'South Forest' },
        ];

        function addLeafRecord(record) {
            leafRecords.push(record);
            const tableBody = document.querySelector('#leaf-records tbody');
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${record.date}</td>
                <td>${record.diseaseId}</td>
                <td>${record.leafName}</td>
                <td>${record.diseaseName}</td>
                <td class="severity-${record.severity.toLowerCase()}">${record.severity}</td>
                <td class="progress-${record.progress.toLowerCase()}">${record.progress}</td>
                <td>${record.location}</td>
            `;
        }

        // Populate initial table
        leafRecords.forEach(addLeafRecord);

        // Set report generation date
        document.getElementById('report-date').textContent = new Date().toLocaleDateString();

        // Create and update charts
        let diseaseDistributionChart, severityTrendChart;

        function updateCharts() {
            const diseaseCounts = {};
            const severityTrend = {};

            leafRecords.forEach(record => {
                diseaseCounts[record.diseaseName] = (diseaseCounts[record.diseaseName] || 0) + 1;
                severityTrend[record.date] = severityTrend[record.date] || { count: 0, total: 0 };
                severityTrend[record.date].count++;
                severityTrend[record.date].total += ['Low', 'Medium', 'High'].indexOf(record.severity) + 1;
            });

            // Update disease distribution chart
            if (diseaseDistributionChart) {
                diseaseDistributionChart.data.labels = Object.keys(diseaseCounts);
                diseaseDistributionChart.data.datasets[0].data = Object.values(diseaseCounts);
                diseaseDistributionChart.update();
            } else {
                diseaseDistributionChart = new Chart(document.getElementById('disease-distribution'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(diseaseCounts),
                        datasets: [{
                            data: Object.values(diseaseCounts),
                            backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Disease Distribution'
                            }
                        }
                    }
                });
            }

            // Update severity trend chart
            const sortedDates = Object.keys(severityTrend).sort();
            const averageSeverities = sortedDates.map(date => severityTrend[date].total / severityTrend[date].count);

            if (severityTrendChart) {
                severityTrendChart.data.labels = sortedDates;
                severityTrendChart.data.datasets[0].data = averageSeverities;
                severityTrendChart.update();
            } else {
                severityTrendChart = new Chart(document.getElementById('severity-trend'), {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Average Severity',
                            data: averageSeverities,
                            borderColor: '#3498db',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 3,
                                ticks: {
                                    callback: function(value) {
                                        return ['Low', 'Medium', 'High'][Math.floor(value) - 1];
                                    }
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Severity Trend Over Time'
                            }
                        }
                    }
                });
            }
        }

        updateCharts();
    </script>
</body>
</html>